# 两阶段翻译工作流程

## 概述

为了让用户更好地控制翻译质量，字幕翻译功能采用**两阶段工作流程**：

### 阶段 1：字幕识别与确认 ✅
用户可以预览 OCR 识别结果，删除错误识别的内容

### 阶段 2：翻译与渲染 🚀
仅翻译用户确认的字幕，生成最终视频

---

## 为什么需要两阶段？

### 问题场景

1. **误识别其他文字**
   - Logo、台标、水印
   - 片头片尾标题
   - 画面中的其他文字信息

2. **位置不准确**
   - 字幕框检测偏移
   - 识别了非字幕区域

3. **OCR 错误**
   - 识别出乱码
   - 空白或无意义内容

### 解决方案

通过两阶段流程，用户可以：
- ✅ 在翻译前检查识别结果
- ✅ 删除不需要翻译的内容
- ✅ 避免浪费 API 调用额度
- ✅ 提高最终翻译质量

---

## 完整工作流程

```
┌─────────────────────────────────────────────────────────┐
│  步骤 1: 上传视频                                         │
│  - 拖拽或点击上传                                         │
│  - 支持 mp4, avi, mov 等格式                             │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步骤 2: 配置和识别                                       │
│  - 选择 "翻译字幕" 模式                                   │
│  - 可选：指定字幕区域                                     │
│  - 点击 "开始识别字幕"                                    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  阶段 1: 字幕识别 (PaddleOCR)                            │
│  - 检测文字框位置                                        │
│  - 过滤非字幕区域                                        │
│  - OCR 识别文字内容                                      │
│  - 合并重复字幕                                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步骤 3: 预览和确认 ✨                                    │
│  ┌───────────────────────────────────────────────────┐  │
│  │  字幕识别结果表格                                   │  │
│  │  ┌──┬────────┬────────┬────────┬──────────┐      │  │
│  │  │☑│ID│字幕内容│出现帧数│首次出现│ 位置     │      │  │
│  │  ├──┼────────┼────────┼────────┼──────────┤      │  │
│  │  │☑│ 0│Hello   │  50   │第 10 帧│Y:880-1080│      │  │
│  │  │☑│ 1│World   │  40   │第 60 帧│Y:880-1080│      │  │
│  │  │☐│ 2│LOGO    │ 500   │第 1 帧 │Y:10-50   │ ❌   │  │
│  │  └──┴────────┴────────┴────────┴──────────┘      │  │
│  │  [全选] [取消全选] [确认并继续(2条)]               │  │
│  └───────────────────────────────────────────────────┘  │
│  - 查看所有识别的字幕                                    │
│  - 取消勾选不需要的内容（如 LOGO）                        │
│  - 查看统计信息（总数/去重/已选）                         │
│  - 点击 "确认并继续"                                     │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步骤 4: 配置翻译参数                                     │
│  - 输入 API Key                                         │
│  - 选择目标语言（中文/English/日本語...）                 │
│  - 选择字幕底色（黑色/白色）                              │
│  - 点击 "开始翻译" 按钮出现                               │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  阶段 2: 翻译和渲染                                       │
│  - 读取用户确认的字幕                                     │
│  - 智能分段（~2000字符）                                 │
│  - 调用 LLM 翻译                                         │
│  - 渲染到视频帧                                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步骤 5: 下载结果                                         │
│  - 实时进度显示                                          │
│  - 处理完成后点击下载                                     │
└─────────────────────────────────────────────────────────┘
```

---

## 用户界面详解

### 步骤 2：模式选择

```
┌────────────────────────────────────┐
│ 处理模式                            │
│ ○ 去除字幕                          │
│ ● 翻译字幕 ← 选择这个                │
│                                    │
│ [开始识别字幕] ← 点击这个按钮        │
└────────────────────────────────────┘
```

### 步骤 3：字幕预览表格

```
┌──────────────────────────────────────────────────────┐
│ 字幕识别结果               共 20 条字幕              │
├──────────────────────────────────────────────────────┤
│ ℹ️ 请检查识别结果，可以删除识别错误的字幕              │
│                                                      │
│ 统计信息：                                            │
│ 总帧数: 1000 | 字幕总数: 50 | 去重后: 20 | 已选择: 18 │
│                                                      │
│ ┌──┬────┬──────────┬────────┬──────┬────────┐      │
│ │☑│ ID │ 字幕内容  │出现帧数│首次  │ 位置    │      │
│ ├──┼────┼──────────┼────────┼──────┼────────┤      │
│ │☑│ 0  │你好世界   │ 50     │第10帧│Y:880-1080│     │
│ │☑│ 1  │欢迎观看   │ 45     │第60帧│Y:880-1080│     │
│ │☐│ 2  │CHANNEL   │ 500    │第1帧 │Y:10-50   │ ❌  │
│ │☐│ 3  │LOGO TEXT │ 500    │第1帧 │Y:10-100  │ ❌  │
│ │☑│ 4  │第一集     │ 30     │第110帧│Y:880-1080│    │
│ └──┴────┴──────────┴────────┴──────┴────────┘      │
│                                                      │
│ [全选] [取消全选] [确认并继续 (18条)]                 │
└──────────────────────────────────────────────────────┘
```

**表格列说明：**
- **☑ 复选框**：勾选=翻译，取消勾选=跳过
- **ID**：字幕唯一标识
- **字幕内容**：OCR 识别的文字
- **出现帧数**：该字幕出现了多少帧
- **首次出现**：第一次出现在第几帧
- **位置**：字幕在画面中的坐标

**操作按钮：**
- **全选**：勾选所有字幕
- **取消全选**：清空所有勾选
- **确认并继续**：确认选择并进入下一步

### 步骤 4：翻译配置

确认字幕后，会显示翻译配置选项：

```
┌────────────────────────────────────┐
│ API Key: [**********]     🔑       │
│ 目标语言: [中文 ▼]                 │
│ 字幕底色: ○ 黑色 ● 白色             │
│                                    │
│ [开始翻译] ← 新出现的按钮           │
└────────────────────────────────────┘
```

---

## 数据存储

### 检测结果文件

**位置**: `/tmp/subtitle-remover/uploads/{task_id}/{task_id}_detected.json`

**内容示例**:
```json
{
  "subtitles": [
    {
      "id": 0,
      "text": "你好世界",
      "frames": [10, 11, 12, ..., 59],
      "frame_count": 50,
      "box": [100, 1820, 880, 1080]
    },
    {
      "id": 1,
      "text": "LOGO",
      "frames": [1, 2, 3, ..., 500],
      "frame_count": 500,
      "box": [50, 250, 10, 50]
    }
  ],
  "total_frames": 1000,
  "subtitle_count": 50,
  "unique_count": 20
}
```

### 确认结果文件

**位置**: `/tmp/subtitle-remover/uploads/{task_id}/{task_id}_confirmed.json`

**内容示例**:
```json
{
  "subtitles": [
    {
      "id": 0,
      "text": "你好世界",
      "frames": [10, 11, 12, ..., 59],
      "frame_count": 50,
      "box": [100, 1820, 880, 1080]
    }
    // 注意：用户删除的 "LOGO" 不在这里
  ],
  "confirmed_at": "user_confirmed"
}
```

---

## API 端点

### 1. 启动字幕检测

**请求**:
```http
POST /api/detect
Content-Type: application/json

{
  "task_id": "uuid-string",
  "sub_area": [880, 1080, 0, 1920]  // 可选
}
```

**响应**:
```json
{
  "task_id": "uuid-string",
  "status": "started",
  "message": "开始检测字幕"
}
```

### 2. 获取检测结果

**请求**:
```http
GET /api/detect/{task_id}
```

**响应（进行中）**:
```json
{
  "task_id": "uuid-string",
  "status": "detecting",
  "message": "正在检测中..."
}
```

**响应（完成）**:
```json
{
  "task_id": "uuid-string",
  "status": "completed",
  "subtitles": [...],
  "total_frames": 1000,
  "subtitle_count": 50,
  "unique_count": 20
}
```

### 3. 确认字幕选择

**请求**:
```http
POST /api/detect/confirm
Content-Type: application/json

{
  "task_id": "uuid-string",
  "confirmed_subtitles": [
    {
      "id": 0,
      "text": "你好世界",
      "frames": [10, 11, ...],
      "box": [100, 1820, 880, 1080]
    }
  ]
}
```

**响应**:
```json
{
  "task_id": "uuid-string",
  "status": "confirmed",
  "message": "已确认 18 条字幕"
}
```

### 4. 启动翻译（阶段2）

**请求**:
```http
POST /api/translate
Content-Type: application/json

{
  "task_id": "uuid-string",
  "api_key": "your-api-key",
  "target_lang": "中文",
  "bg_color": "black"
}
```

**注意**: 必须先完成字幕确认，否则会返回错误：
```json
{
  "detail": "请先完成字幕检测和确认"
}
```

---

## 实际使用示例

### 场景：翻译日语动画

**视频信息**:
- 时长: 24 分钟
- 分辨率: 1920x1080
- 字幕: 日语，位于底部

**操作步骤**:

1. **上传视频**
   - 拖拽 anime_ep01.mp4 到上传区

2. **开始识别**
   - 选择"翻译字幕"模式
   - 点击"开始识别字幕"
   - 等待 2-3 分钟

3. **检查结果**
   - 识别到 150 条字幕
   - 发现其中有：
     - ✅ 140 条正常对话字幕
     - ❌ 5 条片头 LOGO
     - ❌ 3 条片尾标题
     - ❌ 2 条台标

4. **删除误识别**
   - 取消勾选 10 条非字幕内容
   - 点击"确认并继续(140条)"

5. **配置翻译**
   - API Key: `your-key-here`
   - 目标语言: 中文
   - 字幕底色: 黑色

6. **开始翻译**
   - 点击"开始翻译"
   - 等待 5-8 分钟
   - 下载结果

**节省成本**:
- 原本会翻译 150 条（包含 LOGO 等）
- 实际只翻译 140 条
- 节省约 6.7% 的 API 调用

---

## 字幕过滤规则

系统自动过滤非字幕区域，但并非 100% 准确，因此需要用户确认。

### 自动过滤条件

1. **位置过滤**
   ```python
   ymin > frame_height * 0.5  # 下半部分
   ```
   - 保留：底部字幕
   - 过滤：顶部 LOGO、标题

2. **宽高比过滤**
   ```python
   width > height * 3  # 扁平形状
   ```
   - 保留：横向长条字幕
   - 过滤：竖向文字、方形 LOGO

3. **宽度过滤**
   ```python
   width > frame_width * 0.2  # 占一定宽度
   ```
   - 保留：完整句子
   - 过滤：小标签、角标

### 可能误识别的情况

即使有自动过滤，以下情况仍可能被误识别为字幕：

❌ **底部台标**
- 位置：底部
- 形状：横条形
- 解决：用户手动取消勾选

❌ **滚动字幕**
- 片尾职员表
- 解决：用户手动取消勾选

❌ **大面积底部文字**
- 新闻字幕条
- 解决：用户手动取消勾选

这就是为什么需要用户确认环节！

---

## 常见问题

### Q1: 为什么不能跳过确认环节？

**答**: 可以跳过，但不推荐：
- 容易翻译错误内容（LOGO、标题等）
- 浪费 API 调用费用
- 翻译后发现错误需要重新处理

**建议**: 花 1-2 分钟确认，可以节省更多时间和成本

### Q2: 识别结果是空的怎么办？

**可能原因**:
1. 视频没有字幕
2. 字幕区域设置错误
3. OCR 无法识别字体

**解决方法**:
- 检查视频是否真的有硬字幕
- 手动指定字幕区域坐标
- 尝试提高视频清晰度

### Q3: 识别了很多乱码怎么办？

**原因**: OCR 识别错误

**解决**:
- 在确认环节取消勾选乱码内容
- 只保留正常的字幕

### Q4: 能否保存确认结果以便下次使用？

**答**: 当前版本暂不支持，每次都需要重新确认

**未来计划**:
- 支持导出/导入确认结果
- 相似视频复用检测结果

### Q5: 确认后还能修改吗？

**答**: 当前版本不支持修改已确认的结果

**建议**:
- 确认前仔细检查
- 如需修改，重新上传视频

---

## 性能优化建议

### 1. 指定字幕区域

如果知道字幕位置，手动指定可以：
- ✅ 减少误识别
- ✅ 提高识别速度
- ✅ 降低 OCR 负载

**示例** (1080p 底部 200px):
```
Y 最小值: 880
Y 最大值: 1080
X 最小值: 0
X 最大值: 1920
```

### 2. 批量处理相似视频

对于连续剧等相似视频：
1. 第一集：完整流程
2. 后续集：记录确认的字幕位置
3. 使用相同的字幕区域设置

### 3. 分段处理长视频

超过 1 小时的视频：
1. 使用视频编辑软件分段
2. 分别处理每段
3. 最后合并

---

## 总结

两阶段工作流程的优势：

| 特性 | 一步式 | 两阶段 |
|------|-------|--------|
| **准确性** | ⚠️ 可能翻译错误内容 | ✅ 用户确认后翻译 |
| **成本** | 💰 可能浪费 API 调用 | 💵 只翻译确认的内容 |
| **质量** | ⚠️ 无法预览 | ✅ 提前检查 OCR 结果 |
| **控制** | ❌ 自动化，无干预 | ✅ 完全用户控制 |
| **速度** | ⚡ 一次完成 | ⏱️ 需要人工确认 |

**推荐**: 使用两阶段流程，虽然多了一个确认步骤，但可以显著提升最终质量！

---

**文档更新日期**: 2026-02-07
**版本**: 2.0.0 (Two-Stage Workflow)
